---
title: 【JAVA】JVM 篇四 垃圾回收器
date: 2020-07-31
sidebar: auto
categories:
- java
tags:
- jvm
prev: ./garbage
next: ./parameter
---

## 一、串行回收器
串行回收器指使用单线程进行垃圾回收的回收器。每次回收时，串行回收器只有一个工作线程，对于并行能力较弱的计算机来说，串行回收器专注性和独占性往往有更好的性能表现。串行回收器可以在新生代和老年代使用，根据不同的作用域，分为新生代串行回收器和老年代串行回收器。
### 1.1 新生代串行回收器
串行收集器是所有垃圾回收器中最古老的一种，它有两个特点：
- 使用单线程进行垃圾回收
- 独占式的垃圾回收
在串行收集器进行垃圾回收时，java应用程序中的线程都需要暂停，等待垃圾回收的完成。使用`-XX:+UseSerialGC`参数可以指定新生代和老年代串行收集器。新生代串行处理器使用复制算法。当虚拟机在Client模式下运行时，它是默认的垃圾回收器。
:::tip
串行垃圾回收器虽然古老，但是久经考验。在大多数情况下，其性能表现是相当不错的。
:::
### 1.2 老年代串行回收器
老年代串行收集器使用的是标记压缩算法。和新生代串行收集器一样它也是一个串行的、独占式的垃圾回收器。由于老年代垃圾回收通常会使用比新生代回收更长的时间，因此，在堆空间较大的应用程序中，一旦老年代串行收集器启动，应用程序可能会因此挺短较长的时间。
可以使用：
- `-XX:+UseSerialGC`:新生代、老年代都使用串行回收器
- `-XX:+UseParNewGC`:新生代使用ParNew回收器，老年代使用串行回收器
- `-XX:+UseParallelGC`:新生代使用ParallelGC回收器，老年代使用串行回收器

## 二、并行回收器
使用多个线程同时进行垃圾回收。
### 2.1 新生代PerNew回收器
PerNew回收器是工作在新生代的垃圾回收器。简单地将串行回收器多线程化，回收策略、算法以及参数和新生代串行回收器一样。PerNew回收器也是独占式回收器，在收集过程中，应用程序会全部暂停。在多CPU的计算机上使用的话，它的停顿时间要短于串行回收器，而在单CPU或者并发能力较差的系统中，并行回收器的效果不会比串行回收器好，由于多线程的压力，它的实际表现很可能比串行回收器差。
开启PerNew回收器可以使用以下参数：
- `-XX:+UseParNewGC`:新生代使用ParNew回收器，老年代使用串行回收器
- `-XX:+UseConcMarkSweepGC`:新生代使用ParNew回收器，老年代使用CMS

ParNew回收器工作时的线程数量可以使用`-XX:ParallelGCThreads`参数指定，一般，最好与CPU数量相当，避免过多的线程数，影响垃圾回收性能。在默认情况下，当CPU数量小于8个时，ParallelGCThreads 的值等于CPU数量，大于8个时，ParallelGCThreads的值等于3+((5*CPU_COUNT)/8)

### 2.2 新生代ParallelGC回收器
和ParNew回收器类似，但是又一个重要特点是该回收器非常关注系统的吞吐量
- `+XX:+UseParallelGC`:新生代使用ParallelGC回收器，老年代使用串行回收器
- `+XX:+UseParallelOldGC`:新生代使用ParallelGC回收器，老年代使用ParallelOldGC回收器

ParallelGC提供了两个重要参数用于控制系统的吞吐量：
- `-XX:MaxGCPauseMillis`:设置最大垃圾回收停顿时间。如果这个值设置很小，为了达到预期的停顿时间，虚拟机会使用较小的堆（小堆比大堆回收快），而将导致垃圾回收变得很频繁，从而增加了垃圾回收总时间，降低吞吐量。
- `-XX:GCTimeRatio`:设置吞吐量大小。它的值是0-100之间的整数。GCTimeRatio默认值为19，则系统用于垃圾回收的时间不超过1/（1+19） = 5%。默认情况下，它的取值是99，即不超过1%的时间用于垃圾回收。  
:::tip
这两个参数是相互矛盾的，如果减少回收的最大停顿时间，就会减少系统的吞吐量，增加系统吞吐量又可能增加回收的最大停顿时间
:::
还可以使用`-XX:+UseAdaptiveSizePolicy`开启自适应GC策略。在这种情况下，新生代的大小、eden和survivior比例、晋升老年代的对象年龄参数会被自动调整，以达到在堆大小、吞吐量和停顿时间之间的平衡点。

### 2.3 老年代ParallelOldGC回收器
一种多线程并发的回收器。和新生代ParallelGC回收器一样，也是关注吞吐量的收集器。使用`+XX:+UseParallelOldGC`开启老年代使用ParallelOldGC回收器，也可以使用`-XX:ParallelGCThreads`参数指定垃圾回收的线程数量

## 三、CMS回收器
CMS（Concurrent Mark Sweep）回收器主要关注于系统停顿时间。使用的是标记清除算法，也是一个多线程并行回收的垃圾回收器。